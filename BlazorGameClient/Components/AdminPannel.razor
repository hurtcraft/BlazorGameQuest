@using System.Net.Http.Json
@using BlazorGameQuestClassLib
@using System.Text
@inject HttpClient httpClient
@inject PlayerServices playerServices
@inject IJSRuntime JS

<MudStack Spacing="2">
    <h1>Admin Panel</h1>

    <MudButton Variant="Variant.Filled" Color="Color.Success"
               OnClick="ExportCsv">
        Exporter CSV
    </MudButton>

    <MudDataGrid Items="@players" Filterable="false" SortMode="@SortMode.None" Groupable="false">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" />
            <PropertyColumn Property="x => x.Name" Title="Nom" />
            <PropertyColumn Property="x => x.Score" Title="Score" />

            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudStack Row Spacing="1">
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">Modifier</MudButton>
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">Supprimer</MudButton>
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">Bloquer</MudButton>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
</MudStack>

@code {
    private IEnumerable<Player> players = new List<Player>();

    protected override async Task OnInitializedAsync()
    {
        players = await playerServices.GetAllAsync();
    }

    private async Task ExportCsv()
    {
        var sb = new StringBuilder();
        sb.AppendLine("Id;Nom;Score");

        foreach (var p in players)
            sb.AppendLine($"{p.Id};{p.Name};{p.Score}");

        var bytes = Encoding.UTF8.GetBytes(sb.ToString());
        var base64 = Convert.ToBase64String(bytes);

        await JS.InvokeVoidAsync("downloadFileFromBytes", "players.csv", base64);
    }
}
